<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety & Alignment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Segoe UI', 'Segoe UI Web (West European)', 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        /* Demand-Ability Bar Chart */
        .demand-bars {
            display: flex;
            gap: 2.2px; /* Adjusted gap as requested */
            height: 40px;
            align-items: flex-end;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        
        .demand-bar {
            width: 6px;
            height: 40px;
            flex-shrink: 2;
            flex-grow: 0;
            min-width: 2px;
            max-width: 6px;
            border-radius: 0;
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: pixelated;
        }
        
        .bar-red { background-color: #ef4444; }
        .bar-orange { background-color: #eab308; }
        .bar-green { background-color: #84cc16; }
        .bar-gray { background-color: #e5e7eb; }
        .bar-dark { background-color: #0A142D; }

        /* Status Dot Colors */
        .status-dot-red { 
            background-color: #ef4444;
            animation: blink-red 0.6s step-end infinite;
        }
        .status-dot-orange { 
            background-color: #eab308;
        }
        .status-dot-green { background-color: #84cc16; }

        @keyframes blink-red {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        /* Tooltip Logic */
        .has-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            transform: translateY(4px);
            transition: all 0.2s;
        }

    </style>
</head>
<body>

    <!-- Main Header -->
    <header class="bg-[#0A142D] rounded-none p-6 mb-8 shadow-xl max-w-[1400px] mx-auto">
        <h1 class="text-2xl font-bold mb-4 text-white">Agent Safety & Alignment <span class="text-xs opacity-70">Version 0.7</span></h1>
        <div class="flex items-center justify-between w-full text-sm font-semibold">
            <div class="flex items-center gap-6">
                <div class="flex items-center">
                    <span class="w-2.5 h-2.5 rounded-full bg-red-500 mr-2"></span>
                    <span class="text-white">ACTIVE THREATS: 3</span>
                </div>
                <div class="flex items-center">
                    <span class="w-2.5 h-2.5 rounded-full bg-yellow-500 mr-2"></span>
                    <span class="text-white">HIGH LOAD: 4</span>
                </div>
                <div class="flex items-center">
                    <span class="w-2.5 h-2.5 rounded-full bg-cyan-500 mr-2"></span>
                    <span class="text-white">PII ALERTS: 4</span>
                </div>
            </div>
            <div id="captive-agents" class="text-white">CAPTIVE AGENTS: 0</div>
        </div>
    </header>

    <!-- Dashboard Grid -->
    <main class="max-w-[1400px] mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="card-grid">
            <!-- Cards will be injected here by JS -->
        </div>
    </main>

    <script>
        // Data Structure - v0.7.1
        const cards = [
            {
                id: "AG-01",
                name: "FinTech-Advisor-1-01",
                model: "GPT-4o",
                status: "red",
                privacy: { status: "PII ALERT / SSN", type: "warning" },
                demand: { val: 96, color: "red" },
                malice: "4.9",
                maliceColor: "red",
                toxicity: "3.2",
                grounding: "1.2", 
                context: "93k",
                step: "11/20"
            },
            {
                id: "AG-02",
                name: "Support-Agent-2-02",
                model: "Claude-3.5-Sonnet",
                status: "green",
                privacy: { status: "SECURE", type: "secure" },
                demand: { val: 70, color: "green" },
                malice: "1.4",
                maliceColor: "dark",
                toxicity: "1.8",
                grounding: "4.8", 
                context: "104k",
                step: "15/20"
            },
            {
                id: "AG-03",
                name: "Code-Gen-3-03",
                model: "Mistral-Large",
                status: "green",
                privacy: { status: "SECURE", type: "secure" },
                demand: { val: 65, color: "green" },
                malice: "1.4",
                maliceColor: "dark",
                toxicity: "2.1",
                grounding: "4.5",
                context: "75k",
                step: "17/20"
            },
            {
                id: "AG-04",
                name: "HR-Helper-4-04",
                model: "Llama-3-70B",
                status: "green",
                privacy: { status: "SECURE", type: "secure" },
                demand: { val: 60, color: "green" },
                malice: "1.6",
                maliceColor: "dark",
                toxicity: "1.5",
                grounding: "4.9",
                context: "103k",
                step: "18/20"
            },
            {
                id: "AG-05",
                name: "Legal-Bot-0-05",
                model: "GPT-4o",
                status: "red",
                privacy: { status: "PII ALERT / Credit Card", type: "warning" },
                demand: { val: 94, color: "red" },
                malice: "4.7",
                maliceColor: "red",
                toxicity: "3.7",
                grounding: "2.1",
                context: "53k",
                step: "12/20"
            },
            {
                id: "AG-06",
                name: "FinTech-Advisor-1-06",
                model: "Claude-3.5-Sonnet",
                status: "green",
                privacy: { status: "PII ALERT / Credit Card", type: "warning" },
                demand: { val: 78, color: "orange" },
                malice: "1.7",
                maliceColor: "dark",
                toxicity: "2.3",
                grounding: "3.5",
                context: "41k",
                step: "6/20"
            },
            {
                id: "AG-07",
                name: "Support-Agent-2-07",
                model: "Mistral-Large",
                status: "green",
                privacy: { status: "SECURE", type: "secure" },
                demand: { val: 46, color: "green" },
                malice: "1.3",
                maliceColor: "dark",
                toxicity: "1.2",
                grounding: "4.7",
                context: "58k",
                step: "12/20"
            },
            {
                id: "AG-08",
                name: "Code-Gen-3-08",
                model: "Llama-3-70B",
                status: "green",
                privacy: { status: "SECURE", type: "secure" },
                demand: { val: 34, color: "green" },
                malice: "0.6",
                maliceColor: "dark",
                toxicity: "0.7",
                grounding: "5.0",
                context: "39k",
                step: "3/20"
            },
            {
                id: "AG-09",
                name: "HR-Helper-4-09",
                model: "GPT-4o",
                status: "green",
                privacy: { status: "SECURE", type: "secure" },
                demand: { val: 33, color: "green" },
                malice: "1.9",
                maliceColor: "dark",
                toxicity: "2.4",
                grounding: "4.6",
                context: "35k",
                step: "10/20"
            },
            {
                id: "AG-10",
                name: "Legal-Bot-0-10",
                model: "Claude-3.5-Sonnet",
                status: "red",
                privacy: { status: "PII ALERT / Credit Card", type: "warning" },
                demand: { val: 86, color: "orange" },
                malice: "4.6",
                maliceColor: "red",
                toxicity: "3.9",
                grounding: "2.8",
                context: "31k",
                step: "12/20"
            },
            {
                id: "AG-11",
                name: "FinTech-Advisor-1-11",
                model: "Mistral-Large",
                status: "green",
                privacy: { status: "SECURE", type: "secure" },
                demand: { val: 89, color: "orange" },
                malice: "0.7",
                maliceColor: "dark",
                toxicity: "1.9",
                grounding: "3.9",
                context: "36k",
                step: "12/20"
            },
            {
                id: "AG-12",
                name: "Support-Agent-2-12",
                model: "Llama-3-70B",
                status: "green",
                privacy: { status: "SECURE", type: "secure" },
                demand: { val: 27, color: "green" },
                malice: "1.3",
                maliceColor: "dark",
                toxicity: "1.4",
                grounding: "4.4",
                context: "8k",
                step: "11/20"
            }
        ];

        const grid = document.getElementById('card-grid');
        const captiveEl = document.getElementById('captive-agents');
        if (captiveEl) captiveEl.textContent = `CAPTIVE AGENTS: ${cards.length}`;

        // Get the most recent day's demand status for an agent
        function getMostRecentDayStatus(agentId) {
            const pattern = agentPatterns[agentId];
            if (pattern) {
                return pattern[29]; // Last day (index 29)
            }
            return 'green'; // Default
        }

        // Generate 30 vertical bars representing 30 days of historical demand data
        function generateDemandBars(currentDemandVal, agentId) {
            let bars = '';
            
            // Get pattern for this agent, or use default varied pattern
            const pattern = agentPatterns[agentId];
            
            if (pattern) {
                // Use predefined pattern
                for (let i = 0; i < 30; i++) {
                    const barClass = pattern[i] === 'red' ? 'bar-red' : 
                                   pattern[i] === 'orange' ? 'bar-orange' : 'bar-green';
                    bars += `<div class="demand-bar ${barClass}"></div>`;
                }
            } else {
                // Fallback to varied pattern for undefined agents
                const seed = parseInt(agentId.split('-')[1]);
                for (let i = 0; i < 30; i++) {
                    let dailyDemand;
                    if (currentDemandVal >= 85) {
                        dailyDemand = 70 + Math.floor((Math.sin(seed * i * 0.3) * 15 + 15));
                    } else if (currentDemandVal >= 60) {
                        dailyDemand = 40 + Math.floor((Math.sin(seed * i * 0.4) * 25 + 20));
                    } else {
                        dailyDemand = 20 + Math.floor((Math.sin(seed * i * 0.5) * 20 + 15));
                    }
                    dailyDemand = Math.max(10, Math.min(98, dailyDemand));
                    
                    let barClass;
                    if (dailyDemand > 75) {
                        barClass = 'bar-red';
                    } else if (dailyDemand >= 50) {
                        barClass = 'bar-orange';
                    } else {
                        barClass = 'bar-green';
                    }
                    bars += `<div class="demand-bar ${barClass}"></div>`;
                }
            }
            
            // Append a 31st bar using the most recent day's status color
            const recentStatus = getMostRecentDayStatus(agentId);
            const extraClass = recentStatus === 'red' ? 'bar-red' : (recentStatus === 'orange' ? 'bar-orange' : 'bar-green');
            bars += `<div class="demand-bar ${extraClass}"></div>`;
            
            return bars;
        }

        // Generate blocking rate bars (all dark blue)
        function generateBlockingBars(agentId) {
            let bars = '';
            // Generate 30 dark blue bars
            for (let i = 0; i < 30; i++) {
                bars += `<div class="demand-bar bar-dark"></div>`;
            }
            // Add 31st dark blue bar
            bars += `<div class="demand-bar bar-dark"></div>`;
            return bars;
        }

        // Get blocking rate percentage
        function getBlockingRate(agentId) {
            // Random blocking rate between 5 and 25
            const seed = parseInt(agentId.split('-')[1]);
            return Math.floor(5 + (seed * 1.7) % 20);
        }

        // Define agentPatterns globally so it can be accessed by both functions
        const agentPatterns = {
            'AG-01': Array(30).fill('green'),
            'AG-02': Array(30).fill('green').map((val, idx) => {
                if (idx === 22) return 'red';
                if (idx === 23) return 'orange';
                return val;
            }),
            'AG-03': Array(30).fill('green'),
            'AG-04': Array(30).fill('green'),
            'AG-05': Array(30).fill('green').map((val, idx) => {
                return idx < 12 ? 'red' : 'green';
            }),
            'AG-06': Array(30).fill('green'),
            'AG-07': Array(30).fill('green').map((val, idx) => {
                return idx === 29 ? 'orange' : val;
            }),
            'AG-08': Array(30).fill('green'),
            'AG-09': Array(30).fill('green'),
            'AG-10': Array(30).fill('green').map((val, idx) => {
                return idx >= 27 ? 'red' : val;
            }),
            'AG-11': Array(30).fill('green').map((val, idx) => {
                return (idx === 4 || idx === 5) ? 'orange' : val;
            }),
            'AG-12': Array(30).fill('green')
        };

        cards.forEach(card => {
            // Determine status dot color: blink red if malice is red, else fall back to recent demand status
            const recentDayStatus = getMostRecentDayStatus(card.id);
            let statusDotClass;
            if (card.maliceColor === 'red') {
                statusDotClass = 'status-dot-red';
            } else if (recentDayStatus === 'red') {
                statusDotClass = 'status-dot-red';
            } else if (recentDayStatus === 'orange') {
                statusDotClass = 'status-dot-orange';
            } else {
                statusDotClass = 'status-dot-green';
            }

            // Icon Logic
            const fingerprintPath = "M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.2-2.848.578-4.13m4.896-.757C8.636 6.046 7.842 6 7 6a6 6 0 00-6 6";
            
            const privacyIcon = `<svg class="w-4 h-4 mr-1.5 text-[#0a1930]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${fingerprintPath}"></path></svg>`;

            const privacyClass = card.privacy.type === 'warning' ? 'text-[#eab308] font-bold' : 'text-[#66cc00] font-bold';
            
            // Both % and NOW text are always dark blue like the metric labels
            const percentageTextClass = 'text-[#0a1930]';
            const nowTextClass = 'text-[#0a1930]';

            // Malice color logic
            const maliceVal = parseFloat(card.malice);
            let maliceClass;
            if (maliceVal < 2.2) maliceClass = 'text-[#0a1930]';
            else if (maliceVal >= 2.2 && maliceVal <= 3.6) maliceClass = 'text-[#eab308]';
            else maliceClass = 'text-red-500';
            
            // Toxicity color logic
            const toxicityVal = parseFloat(card.toxicity);
            let toxicityClass;
            if (toxicityVal < 2.2) toxicityClass = 'text-[#0a1930]';
            else if (toxicityVal >= 2.2 && toxicityVal <= 3.6) toxicityClass = 'text-[#eab308]';
            else toxicityClass = 'text-red-500';
            
            // Grounding color logic
            const groundingVal = parseFloat(card.grounding);
            let groundingClass;
            if (groundingVal < 2.2) groundingClass = 'text-[#0a1930]';
            else if (groundingVal >= 2.2 && groundingVal <= 3.6) groundingClass = 'text-[#eab308]';
            else groundingClass = 'text-red-500';

            const html = `
                <div class="bg-white shadow-md border-2 border-gray-200 overflow-hidden flex flex-col transition-all duration-200 hover:shadow-xl hover:-translate-y-0.5 cursor-pointer">
                    <!-- Card Header -->
                    <div class="bg-[#0a1930] p-2.5 flex justify-between items-start gap-2">
                        <div class="flex flex-col items-start gap-0.5 min-w-0 flex-shrink-0">
                            <div class="flex items-start gap-2">
                                <div class="w-4 h-4 rounded-full ${statusDotClass} mt-0.5 flex-shrink-0"></div>
                                <div class="text-white text-sm font-bold whitespace-nowrap">${card.id.replace('AG-', 'AG-0')}</div>
                            </div>
                            <div class="text-gray-400 text-[9px] font-medium ml-6 whitespace-nowrap">Host: Databricks</div>
                        </div>
                        <div class="text-right min-w-0 flex-shrink">
                            <div class="text-white font-bold text-sm tracking-tight truncate" title="${card.name}">${card.name}</div>
                            <div class="text-gray-400 text-[9px] font-medium mt-0.5 whitespace-nowrap">Model: Claude Sonnet 4.1</div>
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="p-4 flex-grow">
                        <!-- Privacy Row -->
                        <div class="flex items-center text-[10px] uppercase font-bold tracking-wider text-[#0a1930] mb-4">
                                <span class="mr-2 flex items-center">
                                    <span>Data Privacy</span>
                                    <span class="ml-1">${privacyIcon}</span>
                                </span>
                                <div class="flex items-center ${privacyClass}">
                                    ${card.privacy.status}
                                </div>
                        </div>

                        <!-- Demand Ability Bars (Full Width) -->
                        <div class="flex flex-col mb-4">
                            <div class="text-[10px] font-bold text-[#0a1930] uppercase tracking-wider mb-2">Demand Ability (Cognitive Load)</div>
                            <div class="flex items-center gap-1 min-w-0">
                                <div class="demand-bars flex-1 min-w-0">
                                    ${generateDemandBars(card.demand.val, card.id)}
                                </div>
                                <div class="flex flex-col items-start flex-shrink-0">
                                    <div class="text-sm font-bold ${percentageTextClass} leading-none whitespace-nowrap">${card.demand.val}%</div>
                                    <div class="text-[10px] font-bold ${nowTextClass} uppercase tracking-wider mt-0.5 whitespace-nowrap">Load</div>
                                </div>
                            </div>
                        </div>

                        <!-- Malice/Toxicity/Grounding Stats Row (All left-aligned, closer together) -->
                        <div class="flex items-start gap-4 mb-4">
                            <div class="flex flex-col items-start">
                                <div class="text-[10px] font-bold text-[#0a1930] uppercase tracking-wider">Malice</div>
                                <div class="text-xl font-bold ${maliceClass} leading-none mt-1">${card.malice}</div>
                            </div>
                            <div class="flex flex-col items-start">
                                <div class="text-[10px] font-bold text-[#0a1930] uppercase tracking-wider">Toxicity</div>
                                <div class="text-xl font-bold ${toxicityClass} leading-none mt-1">${card.toxicity}</div>
                            </div>
                            <div class="flex flex-col items-start">
                                <div class="text-[10px] font-bold text-[#0a1930] uppercase tracking-wider">Grounding</div>
                                <div class="text-xl font-bold ${groundingClass} leading-none mt-1">${card.grounding}</div>
                            </div>
                        </div>

                        <!-- Blocking Rate Bars -->
                        <div class="flex flex-col">
                            <div class="text-[10px] font-bold text-[#0a1930] uppercase tracking-wider mb-2">Blocking Interventions</div>
                            <div class="flex items-center gap-1 min-w-0">
                                <div class="demand-bars flex-1 min-w-0">
                                    ${generateBlockingBars(card.id)}
                                </div>
                                <div class="flex flex-col items-start flex-shrink-0">
                                    <div class="text-sm font-bold ${percentageTextClass} leading-none whitespace-nowrap">${getBlockingRate(card.id)}%</div>
                                    <div class="text-[10px] font-bold ${nowTextClass} uppercase tracking-wider mt-0.5 whitespace-nowrap">Rate</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Info (Agentic Health) -->
                    <div class="bg-gray-50/50 px-4 py-3 border-t border-gray-100 flex justify-between items-center text-xs font-semibold text-[#0a1930] relative">
                        
                        <!-- Context Usage Tooltip -->
                        <div class="flex items-center cursor-help has-tooltip group relative">
                            <div class="tooltip-content absolute bottom-full left-0 mb-2 px-2 py-1 bg-gray-800 text-white text-[10px] rounded shadow-lg whitespace-nowrap z-20">
                                Risk: "Lost in the Middle" Syndrome<br>Buffer Usage / Max
                            </div>
                            <!-- Chip Icon -->
                            <svg class="w-4 h-4 mr-1.5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>
                            ${card.context} Context
                        </div>

                        <!-- Step/Time Horizon Tooltip -->
                        <div class="flex items-center cursor-help has-tooltip group relative">
                            <div class="tooltip-content absolute bottom-full right-0 mb-2 px-2 py-1 bg-gray-800 text-white text-[10px] rounded shadow-lg whitespace-nowrap z-20 text-right">
                                Agentic Time Horizon<br>Monitor for Loop Failures
                            </div>
                            <!-- Pulse Icon -->
                            <svg class="w-4 h-4 mr-1.5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Step ${card.step}
                        </div>
                    </div>
                </div>
            `;
            
            grid.innerHTML += html;
        });
    </script>
</body>
</html>